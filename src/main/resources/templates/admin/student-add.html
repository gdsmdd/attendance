<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>添加学生 - 二维码签到系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .sidebar {
            min-height: 100vh;
            background: #2c3e50;
            color: white;
        }
        .sidebar a {
            color: white;
            text-decoration: none;
            padding: 10px 15px;
            display: block;
            border-left: 3px solid transparent;
        }
        .sidebar a:hover, .sidebar a.active {
            background: #34495e;
            border-left-color: #3498db;
        }
        .main-content {
            padding: 20px;
            background: #f8f9fa;
            min-height: 100vh;
        }
        .form-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .required::after {
            content: " *";
            color: #dc3545;
        }
        .password-toggle {
            cursor: pointer;
            color: #6c757d;
        }
        .password-toggle:hover {
            color: #495057;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- 侧边栏 -->
        <div class="col-md-2 p-0 sidebar">
            <div class="p-3">
                <h4 class="text-center mb-4">
                    <i class="bi bi-qr-code"></i> 签到系统
                </h4>
                <div class="user-info text-center mb-4">
                    <i class="bi bi-shield-lock fs-2 mb-2"></i>
                    <h6>管理员</h6>
                    <p class="mb-1" th:text="${admin.name}">系统管理员</p>
                    <small th:text="${admin.username}">admin</small>
                </div>

                <nav class="nav flex-column">
                    <a th:href="@{/admin/dashboard}" class="nav-link">
                        <i class="bi bi-speedometer2"></i> 仪表板
                    </a>
                    <a th:href="@{/admin/teachers}" class="nav-link">
                        <i class="bi bi-person-badge"></i> 教师管理
                    </a>
                    <a th:href="@{/admin/students}" class="nav-link active">
                        <i class="bi bi-people"></i> 学生管理
                    </a>
                    <a th:href="@{/admin/departments}" class="nav-link">
                        <i class="bi bi-building"></i> 院系管理
                    </a>
                    <div class="mt-4">
                        <a th:href="@{/logout}" class="nav-link text-danger">
                            <i class="bi bi-box-arrow-right"></i> 退出登录
                        </a>
                    </div>
                </nav>
            </div>
        </div>

        <!-- 主内容区 -->
        <div class="col-md-10 main-content">
            <!-- 页面标题和操作按钮 -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3><i class="bi bi-person-plus"></i> 添加学生</h3>
                <div>
                    <a th:href="@{/admin/students}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> 返回列表
                    </a>
                </div>
            </div>

            <!-- 消息提示 -->
            <div th:if="${error}" class="alert alert-danger">
                <i class="bi bi-exclamation-circle"></i>
                <span th:text="${error}"></span>
            </div>

            <!-- 添加学生表单 -->
            <div class="card form-container">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> 学生信息</h5>
                </div>
                <div class="card-body">
                    <form th:action="@{/admin/students/add}" method="post" id="studentForm">
                        <div class="row">
                            <!-- 基本信息 -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentId" class="form-label required">学号</label>
                                    <input type="text" class="form-control" id="studentId" name="studentId"
                                           placeholder="请输入学号（如：20231001）" required>
                                    <div class="form-text">学号将作为学生的唯一标识，不可重复</div>
                                </div>

                                <div class="mb-3">
                                    <label for="name" class="form-label required">姓名</label>
                                    <input type="text" class="form-control" id="name" name="name"
                                           placeholder="请输入学生姓名" required>
                                </div>

                                <div class="mb-3">
                                    <label for="username" class="form-label required">用户名</label>
                                    <input type="text" class="form-control" id="username" name="username"
                                           placeholder="请输入登录用户名" required>
                                    <div class="form-text">用户名用于登录系统，不可重复</div>
                                </div>

                                <div class="mb-3">
                                    <label for="enrollmentYear" class="form-label required">入学年份</label>
                                    <select class="form-select" id="enrollmentYear" name="enrollmentYear" required>
                                        <option value="">请选择入学年份</option>
                                        <option
                                                th:with="currentYear = ${#temporals.createNow().year}"
                                                th:each="offset : ${#numbers.sequence(-4, 0)}"
                                                th:value="${currentYear + offset}"
                                                th:text="${currentYear + offset}">
                                            2023
                                        </option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="password" class="form-label required">密码</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="password" name="password"
                                               placeholder="请输入登录密码" required>
                                        <span class="input-group-text password-toggle" id="togglePassword">
                                                <i class="bi bi-eye"></i>
                                            </span>
                                    </div>
                                    <div class="form-text">建议使用字母+数字组合，至少6位</div>
                                </div>

                                <div class="mb-3">
                                    <label for="confirmPassword" class="form-label required">确认密码</label>
                                    <input type="password" class="form-control" id="confirmPassword"
                                           placeholder="请再次输入密码" required>
                                    <div class="invalid-feedback" id="passwordError">两次输入的密码不一致</div>
                                </div>

                                <div class="mb-3">
                                    <label for="className" class="form-label required">行政班级</label>
                                    <input type="text" class="form-control" id="className" name="className"
                                           placeholder="请输入行政班级（如：23计科1班）" required>
                                    <div class="form-text">格式：入学年份+专业+班级</div>
                                </div>

                                <div class="mb-3">
                                    <label for="departmentId" class="form-label required">所属院系</label>
                                    <select class="form-select" id="departmentId" name="departmentId" required>
                                        <option value="">请选择院系</option>
                                        <option th:each="dept : ${departments}"
                                                th:value="${dept.id}"
                                                th:text="${dept.name}">
                                            计算机学院
                                        </option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- 状态 -->
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label required">账号状态</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="status"
                                                   id="statusActive" value="ACTIVE" checked>
                                            <label class="form-check-label" for="statusActive">
                                                <i class="bi bi-check-circle text-success"></i> 启用
                                            </label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="status"
                                                   id="statusInactive" value="INACTIVE">
                                            <label class="form-check-label" for="statusInactive">
                                                <i class="bi bi-x-circle text-danger"></i> 停用
                                            </label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="status"
                                                   id="statusGraduated" value="GRADUATED">
                                            <label class="form-check-label" for="statusGraduated">
                                                <i class="bi bi-mortarboard text-secondary"></i> 已毕业
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 表单操作按钮 -->
                        <div class="row">
                            <div class="col-12">
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                        <i class="bi bi-arrow-clockwise"></i> 重置
                                    </button>
                                    <div>
                                        <button type="button" class="btn btn-outline-secondary" onclick="goBack()">
                                            取消
                                        </button>
                                        <button type="submit" class="btn btn-primary" id="submitBtn">
                                            <i class="bi bi-save"></i> 保存
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 操作指南 -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-lightbulb"></i> 填写说明</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>必填项说明：</h6>
                            <ul>
                                <li><span class="text-danger">*</span> 学号：学生唯一标识，用于系统识别</li>
                                <li><span class="text-danger">*</span> 姓名：学生的真实姓名</li>
                                <li><span class="text-danger">*</span> 用户名：登录系统的账号</li>
                                <li><span class="text-danger">*</span> 密码：登录系统的密码</li>
                                <li><span class="text-danger">*</span> 行政班级：学生所属的班级</li>
                                <li><span class="text-danger">*</span> 入学年份：学生入学时间</li>
                                <li><span class="text-danger">*</span> 所属院系：学生所属的教学单位</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>状态说明：</h6>
                            <ul>
                                <li><strong>启用</strong>：学生可以正常登录和签到</li>
                                <li><strong>停用</strong>：学生无法登录系统</li>
                                <li><strong>已毕业</strong>：学生账号保留，但不再参与新课程</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 显示/隐藏密码
    $('#togglePassword').click(function() {
        const passwordInput = $('#password');
        const icon = $(this).find('i');

        if (passwordInput.attr('type') === 'password') {
            passwordInput.attr('type', 'text');
            icon.removeClass('bi-eye').addClass('bi-eye-slash');
        } else {
            passwordInput.attr('type', 'password');
            icon.removeClass('bi-eye-slash').addClass('bi-eye');
        }
    });

    // 密码验证
    $('#confirmPassword').on('input', function() {
        const password = $('#password').val();
        const confirmPassword = $(this).val();
        const errorDiv = $('#passwordError');

        if (confirmPassword && password !== confirmPassword) {
            $(this).addClass('is-invalid');
            errorDiv.show();
        } else {
            $(this).removeClass('is-invalid');
            errorDiv.hide();
        }
    });

    // 表单验证
    $('#studentForm').submit(function(e) {
        e.preventDefault();

        // 验证必填项
        let isValid = true;
        $('input[required], select[required]').each(function() {
            if (!$(this).val()) {
                $(this).addClass('is-invalid');
                isValid = false;
            } else {
                $(this).removeClass('is-invalid');
            }
        });

        // 验证密码
        const password = $('#password').val();
        const confirmPassword = $('#confirmPassword').val();
        if (password !== confirmPassword) {
            $('#confirmPassword').addClass('is-invalid');
            $('#passwordError').show();
            isValid = false;
        }

        // 验证学号格式
        const studentId = $('#studentId').val();
        if (studentId && !/^\d+$/.test(studentId)) {
            $('#studentId').addClass('is-invalid');
            $('#studentId').next('.form-text').addClass('text-danger');
            $('#studentId').next('.form-text').text('学号只能包含数字');
            isValid = false;
        }

        // 验证用户名格式
        const username = $('#username').val();
        if (username && !/^[a-zA-Z0-9_]+$/.test(username)) {
            $('#username').addClass('is-invalid');
            $('#username').next('.form-text').addClass('text-danger');
            $('#username').next('.form-text').text('用户名只能包含字母、数字和下划线');
            isValid = false;
        }

        // 验证入学年份
        const enrollmentYear = $('#enrollmentYear').val();
        if (enrollmentYear && !/^\d{4}$/.test(enrollmentYear)) {
            $('#enrollmentYear').addClass('is-invalid');
            isValid = false;
        }

        if (isValid) {
            // 显示加载状态
            const submitBtn = $('#submitBtn');
            submitBtn.prop('disabled', true);
            submitBtn.html('<i class="bi bi-hourglass-split"></i> 保存中...');

            // 提交表单
            setTimeout(() => {
                this.submit();
            }, 500);
        } else {
            // 滚动到第一个错误位置
            $('html, body').animate({
                scrollTop: $('.is-invalid').first().offset().top - 100
            }, 500);
        }
    });

    // 输入框实时验证
    $('input, select').on('input change', function() {
        if ($(this).hasClass('is-invalid')) {
            $(this).removeClass('is-invalid');
            if ($(this).attr('id') === 'studentId') {
                $(this).next('.form-text').removeClass('text-danger');
                $(this).next('.form-text').text('学号将作为学生的唯一标识，不可重复');
            }
            if ($(this).attr('id') === 'username') {
                $(this).next('.form-text').removeClass('text-danger');
                $(this).next('.form-text').text('用户名用于登录系统，不可重复');
            }
        }
    });

    // 重置表单
    function resetForm() {
        if (confirm('确定要重置表单吗？所有填写的内容都将被清除。')) {
            $('#studentForm')[0].reset();
            $('.is-invalid').removeClass('is-invalid');
            $('#passwordError').hide();
            $('html, body').animate({ scrollTop: 0 }, 500);
        }
    }

    // 返回列表
    function goBack() {
        if ($('#studentForm')[0].checkValidity()) {
            if (confirm('确定要取消吗？已填写的内容将不会被保存。')) {
                window.location.href = 'admin/students';
            }
        } else {
            window.location.href = 'admin/students';
        }
    }

    // 页面加载时自动聚焦到第一个输入框
    $(document).ready(function() {
        $('#studentId').focus();

        // 自动生成入学年份选项
        const yearSelect = $('#enrollmentYear');
        if (yearSelect.children().length <= 1) {
            const currentYear = new Date().getFullYear();
            for (let i = 0; i <= 4; i++) {
                const year = currentYear - i;
                yearSelect.append(`<option value="${year}">${year}</option>`);
            }
        }

        // 自动关闭警告框
        setTimeout(function() {
            $('.alert').alert('close');
        }, 5000);
    });
</script>
</body>
</html>